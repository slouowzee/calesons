import React, { useEffect, useState, useRef } from "react";
import { StyleSheet, Alert, useWindowDimensions, Platform, Vibration, Linking, PixelRatio } from "react-native";
import { Camera, useCameraDevice, useCodeScanner } from "react-native-vision-camera";
import { View, Text, Button, YStack } from "tamagui";
import { useIsFocused } from "@react-navigation/native";
import { RESULTS } from "react-native-permissions";
import appColors from "../../lib/theme";
import { EPermissionTypes, usePermissions } from "../../hooks/usePermissions";
import { useAppStateListener } from "../../hooks/useAppStateListener";

export default function ScanScreen() {
  const { width: screenWidth, height: screenHeight } = useWindowDimensions();
  const device = useCameraDevice("back");
  const isFocused = useIsFocused();
  
  const [hasPermission, setHasPermission] = useState(false);
  const [isScanning, setIsScanning] = useState(true);
  const isScanningRef = useRef(true);

  const { askPermissions } = usePermissions(EPermissionTypes.CAMERA);
  const { appState } = useAppStateListener();

  const reticleSize = 280;
  const centerY = screenHeight / 2;
  const centerX = screenWidth / 2;

  useEffect(() => {
    const checkPermissions = async () => {
      const result = await askPermissions();
      if (result.type === RESULTS.GRANTED || result.type === RESULTS.LIMITED) {
        setHasPermission(true);
      }
    };
    checkPermissions();
  }, [askPermissions]);

  useEffect(() => {
    isScanningRef.current = isScanning;
  }, [isScanning]);

  const codeScanner = useCodeScanner({
    codeTypes: ["qr", "ean-13"],
    onCodeScanned: (codes) => {
      if (!isScanningRef.current || codes.length === 0) return;
      const code = codes[0];
      if (!code.value || !code.frame) return;

      const qrX = (code.frame.x + code.frame.width / 2) / PixelRatio.get();
      const qrY = (code.frame.y + code.frame.height / 2) / PixelRatio.get();

      // On calcule la distance max par rapport au centre sur les deux axes possibles (Portrait/Landscape)
      const distNormal = Math.max(Math.abs(qrX - centerX), Math.abs(qrY - centerY));
      const distInverted = Math.max(Math.abs(qrY - centerX), Math.abs(qrX - centerY));

      // Seuil strict : le centre du QR doit être dans le carré de 280px (+ petite marge)
      const threshold = (reticleSize / 2) + 20;

      if (distNormal < threshold || distInverted < threshold) {
        isScanningRef.current = false;
        setIsScanning(false);
        Vibration.vibrate(100);
        Alert.alert("Code détecté", code.value, [
          { text: "OK", onPress: () => { setIsScanning(true); isScanningRef.current = true; } }
        ]);
      }
    }
  });

  if (!hasPermission || device == null) {
    return (
      <View flex={1} backgroundColor={appColors.background} justifyContent="center" alignItems="center">
        <Text color={appColors.text}>{!hasPermission ? "Demande de permission..." : "Caméra non détectée"}</Text>
      </View>
    );
  }

  return (
    <View flex={1} backgroundColor="black">
      <Camera style={StyleSheet.absoluteFill} device={device} isActive={isFocused && isScanning && appState === "active"} codeScanner={codeScanner} enableZoomGesture photo={false} />
      
      <View style={StyleSheet.absoluteFill} pointerEvents="none" justifyContent="center">
        <View flex={1} backgroundColor="rgba(0,0,0,0.6)" />
        <View flexDirection="row" height={reticleSize}>
          <View flex={1} backgroundColor="rgba(0,0,0,0.6)" />
          <View width={reticleSize} height={reticleSize} backgroundColor="transparent" />
          <View flex={1} backgroundColor="rgba(0,0,0,0.6)" />
        </View>
        <View flex={1} backgroundColor="rgba(0,0,0,0.6)" />
      </View>

      <View style={StyleSheet.absoluteFill} pointerEvents="none" justifyContent="center" alignItems="center">
        <View width={reticleSize} height={reticleSize}>
          <View position="absolute" top={0} left={0} width={45} height={45} borderTopWidth={6} borderLeftWidth={6} borderColor={appColors.primary} borderTopLeftRadius={30} />
          <View position="absolute" top={0} right={0} width={45} height={45} borderTopWidth={6} borderRightWidth={6} borderColor={appColors.primary} borderTopRightRadius={30} />
          <View position="absolute" bottom={0} left={0} width={45} height={45} borderBottomWidth={6} borderLeftWidth={6} borderColor={appColors.primary} borderBottomLeftRadius={30} />
          <View position="absolute" bottom={0} right={0} width={45} height={45} borderBottomWidth={6} borderRightWidth={6} borderColor={appColors.primary} borderBottomRightRadius={30} />
        </View>
      </View>

      {!isScanning && (
        <YStack position="absolute" bottom={120} width="100%" alignItems="center">
          <Button backgroundColor={appColors.primary} color="white" size="$5" borderRadius={999} onPress={() => setIsScanning(true)}>Scanner à nouveau</Button>
        </YStack>
      )}
    </View>
  );
}
